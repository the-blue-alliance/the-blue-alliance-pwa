on: push
name: Build, test, and deploy
jobs:
  build:
    name: Install packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: Install packages
        uses: actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680
        with:
          args: install
      - name: Test
        uses: actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680
        env:
          CI: "true"
        with:
          args: test
      - name: Build
        uses: actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680
        env:
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          STACKDRIVER_API_KEY: ${{ secrets.STACKDRIVER_API_KEY }}
          TBA_API_AUTH_KEY: ${{ secrets.TBA_API_AUTH_KEY }}
        with:
          args: run build
      - name: Check lint
        uses: actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680
        with:
          args: run lint
      - name: Check formatting
        uses: actions/npm@59b64a598378f31e49cb76f27d6f3312b582f680
        with:
          args: run prettier
      - name: Send coverage reports to Codecov
        uses: docker://node
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          entrypoint: npx
          args: codecov
      - name: Is master branch
        uses: actions/bin/filter@3c0b4f0e63ea54ea5df2914b4fabf383368cd0da
        with:
          args: branch master
      - name: Authenticate Google Cloud
        uses: actions/gcloud/auth@ba93088eb19c4a04638102a838312bb32de0b052
        env:
          GCLOUD_AUTH: ${{ secrets.GCLOUD_AUTH }}
      - name: Is not [nodeploy]
        uses: ./.github/actions/filter-commit-message
        with:
          args: -n \[nodeploy\]
      - name: Deploy
        uses: actions/gcloud/cli@ba93088eb19c4a04638102a838312bb32de0b052
        with:
          args: app deploy --project tbatv-prod-hrd --version 1 --quiet
